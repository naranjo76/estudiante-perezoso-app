// Badge System
        const BADGES = {
            'primera-llama': {
                id: 'primera-llama',
                name: 'Primera Llama',
                description: 'Completa tu primera sesión',
                emoji: '🔥',
                points: 20,
                condition: (stats) => stats.totalSessions >= 1
            },
            'constante': {
                id: 'constante',
                name: 'Constante',
                description: '3 días seguidos',
                emoji: '🌟',
                points: 50,
                condition: (stats) => stats.studyStreak >= 3
            },
            'imparable': {
                id: 'imparable',
                name: 'Imparable',
                description: '7 días seguidos',
                emoji: '💪',
                points: 100,
                condition: (stats) => stats.studyStreak >= 7
            },
            'maquina': {
                id: 'maquina',
                name: 'Máquina',
                description: '30 días seguidos',
                emoji: '🦾',
                points: 500,
                condition: (stats) => stats.studyStreak >= 30
            },
            'maestro-zombie': {
                id: 'maestro-zombie',
                name: 'Maestro Zombie',
                description: '10 sesiones en modo Zombie',
                emoji: '🧟‍♂️',
                points: 75,
                condition: (stats) => stats.zombieSessions >= 10
            },
            'sabio-tortuga': {
                id: 'sabio-tortuga',
                name: 'Sabio Tortuga',
                description: '10 sesiones en modo Tortuga',
                emoji: '🐢',
                points: 100,
                condition: (stats) => stats.turtleSessions >= 10
            },
            'rayo-liebre': {
                id: 'rayo-liebre',
                name: 'Rayo Liebre',
                description: '10 sesiones en modo Liebre',
                emoji: '🐰',
                points: 150,
                condition: (stats) => stats.rabbitSessions >= 10
            },
            'madrugador': {
                id: 'madrugador',
                name: 'Madrugador',
                description: 'Estudiar antes de 8am',
                emoji: '🌅',
                points: 60,
                condition: (stats) => stats.earlySessions >= 1
            },
            'nocturno': {
                id: 'nocturno',
                name: 'Nocturno',
                description: 'Estudiar después de 8pm',
                emoji: '🦉',
                points: 60,
                condition: (stats) => stats.lateSessions >= 1
            },
            'centurion': {
                id: 'centurion',
                name: 'Centurión',
                description: '100 sesiones completadas',
                emoji: '💯',
                points: 1000,
                condition: (stats) => stats.totalSessions >= 100
            }
        };

        // Activity Calendar Component (simplified for space)
        const ActivityCalendar = ({ dailyActivity }) => {
            const today = new Date();
            const startDate = new Date(today.getFullYear(), today.getMonth() - 2, 1);
            const endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            const getDaysInRange = () => {
                const days = [];
                const current = new Date(startDate);
                
                while (current <= endDate) {
                    days.push(new Date(current));
                    current.setDate(current.getDate() + 1);
                }
                
                return days;
            };

            const getActivityLevel = (date) => {
                const dateKey = date.toDateString();
                const sessions = dailyActivity[dateKey] || 0;
                
                if (sessions === 0) return 'no-activity';
                if (sessions <= 1) return 'low-activity';
                if (sessions <= 3) return 'medium-activity';
                return 'high-activity';
            };

            const days = getDaysInRange();
            const weekdays = ['D', 'L', 'M', 'M', 'J', 'V', 'S'];

            return (
                <div className="bg-white rounded-2xl p-4">
                    <h3 className="font-semibold mb-4 flex items-center gap-2">
                        <Calendar />
                        Actividad de Estudio
                    </h3>
                    
                    <div className="text-xs text-gray-500 mb-2 grid grid-cols-7 gap-2">
                        {weekdays.map(day => (
                            <div key={day} className="text-center">{day}</div>
                        ))}
                    </div>
                    
                    <div className="calendar-grid mb-4">
                        {days.map((day, index) => (
                            <div
                                key={index}
                                className={`calendar-day ${getActivityLevel(day)}`}
                                title={`${day.toLocaleDateString()}: ${dailyActivity[day.toDateString()] || 0} sesiones`}
                            />
                        ))}
                    </div>
                    
                    <div className="flex items-center justify-between text-xs text-gray-500">
                        <span>Menos</span>
                        <div className="flex gap-1">
                            <div className="calendar-day no-activity w-3 h-3"></div>
                            <div className="calendar-day low-activity w-3 h-3"></div>
                            <div className="calendar-day medium-activity w-3 h-3"></div>
                            <div className="calendar-day high-activity w-3 h-3"></div>
                        </div>
                        <span>Más</span>
                    </div>
                </div>
            );
        };

        // Simplified components for space
        const WeeklyChart = ({ weeklyData }) => {
            const weekdays = ['Lun', 'Mar', 'Mie', 'Jue', 'Vie', 'Sab', 'Dom'];
            const maxSessions = Math.max(...Object.values(weeklyData), 1);
            
            return (
                <div className="bg-white rounded-2xl p-4">
                    <h3 className="font-semibold mb-4 flex items-center gap-2">
                        <BarChart />
                        Sesiones por Día de la Semana
                    </h3>
                    
                    <div className="bar-chart">
                        {weekdays.map((day, index) => {
                            const sessions = weeklyData[index] || 0;
                            const height = (sessions / maxSessions) * 100;
                            
                            return (
                                <div key={day} className="flex flex-col items-center gap-2">
                                    <div className="text-xs text-gray-600 font-medium">{sessions}</div>
                                    <div
                                        className="bar"
                                        style={{ height: `${Math.max(height, 5)}%` }}
                                        title={`${day}: ${sessions} sesiones`}
                                    />
                                    <div className="text-xs text-gray-500">{day}</div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const Goals = ({ sessionStats, studyStreak }) => {
            const goals = [
                {
                    name: 'Sesiones Totales',
                    current: sessionStats.totalSessions,
                    target: Math.max(50, Math.ceil(sessionStats.totalSessions / 10) * 10),
                    emoji: '🎯',
                    unit: 'sesiones'
                },
                {
                    name: 'Racha Actual',
                    current: studyStreak,
                    target: Math.max(30, Math.ceil(studyStreak / 7) * 7),
                    emoji: '🔥',
                    unit: 'días'
                }
            ];

            return (
                <div className="bg-white rounded-2xl p-4">
                    <h3 className="font-semibold mb-4 flex items-center gap-2">
                        <Target />
                        Metas Personales
                    </h3>
                    
                    <div className="space-y-4">
                        {goals.map((goal, index) => {
                            const percentage = Math.min((goal.current / goal.target) * 100, 100);
                            const isCompleted = goal.current >= goal.target;
                            
                            return (
                                <div key={index} className="space-y-2">
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center gap-2">
                                            <span className="text-lg">{goal.emoji}</span>
                                            <span className="font-medium text-sm">{goal.name}</span>
                                        </div>
                                        <div className="text-sm">
                                            <span className={`font-bold ${isCompleted ? 'text-green-600' : 'text-gray-600'}`}>
                                                {goal.current}
                                            </span>
                                            <span className="text-gray-400">/{goal.target} {goal.unit}</span>
                                        </div>
                                    </div>
                                    <div className="progress-bar">
                                        <div 
                                            className="progress-fill"
                                            style={{ width: `${percentage}%` }}
                                        />
                                    </div>
                                    {isCompleted && (
                                        <div className="text-xs text-green-600 font-medium">
                                            ✅ ¡Meta completada!
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const StatsOverview = ({ sessionStats, totalPoints, studyStreak }) => {
            const totalMinutes = (sessionStats.zombieSessions * 2) + 
                               (sessionStats.turtleSessions * 15) + 
                               (sessionStats.rabbitSessions * 45);
            
            const averageSessionsPerDay = sessionStats.totalSessions > 0 ? 
                (sessionStats.totalSessions / Math.max(studyStreak, 1)).toFixed(1) : 0;
            
            const stats = [
                {
                    title: 'Tiempo Total',
                    value: `${Math.floor(totalMinutes / 60)}h ${totalMinutes % 60}m`,
                    emoji: '⏱️',
                    color: 'text-blue-600'
                },
                {
                    title: 'Sesiones Promedio',
                    value: `${averageSessionsPerDay}/día`,
                    emoji: '📊',
                    color: 'text-green-600'
                }
            ];

            return (
                <div className="bg-white rounded-2xl p-4">
                    <h3 className="font-semibold mb-4">📈 Resumen General</h3>
                    
                    <div className="grid grid-cols-2 gap-4">
                        {stats.map((stat, index) => (
                            <div key={index} className="text-center p-3 bg-gray-50 rounded-xl">
                                <div className="text-2xl mb-1">{stat.emoji}</div>
                                <div className={`text-xl font-bold ${stat.color}`}>
                                    {stat.value}
                                </div>
                                <div className="text-xs text-gray-500 mt-1">
                                    {stat.title}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const StatsDashboard = ({ onClose, sessionStats, totalPoints, studyStreak, dailyActivity }) => {
            const [activeTab, setActiveTab] = useState('overview');
            
            const tabs = [
                { id: 'overview', label: 'Resumen', icon: '📊' },
                { id: 'calendar', label: 'Calendario', icon: '📅' },
                { id: 'charts', label: 'Gráficos', icon: '📈' },
                { id: 'goals', label: 'Metas', icon: '🎯' }
            ];

            const getWeeklyData = () => {
                const weeklyData = Array(7).fill(0);
                Object.entries(dailyActivity).forEach(([dateStr, sessions]) => {
                    const date = new Date(dateStr);
                    const dayOfWeek = (date.getDay() + 6) % 7;
                    weeklyData[dayOfWeek] += sessions;
                });
                return weeklyData;
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4">
                    <div className="bg-gray-100 rounded-3xl max-w-md w-full max-h-[90vh] overflow-hidden">
                        <div className="sticky top-0 bg-gradient-to-r from-blue-500 to-purple-500 text-white p-6 rounded-t-3xl">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <BarChart />
                                    <h2 className="text-xl font-bold">Estadísticas</h2>
                                </div>
                                <button 
                                    onClick={onClose}
                                    className="text-white text-2xl font-bold hover:bg-white hover:bg-opacity-20 rounded-full w-8 h-8 flex items-center justify-center"
                                >
                                    <X />
                                </button>
                            </div>
                        </div>
                        
                        <div className="p-4">
                            <div className="nav-tabs">
                                {tabs.map(tab => (
                                    <button
                                        key={tab.id}
                                        onClick={() => setActiveTab(tab.id)}
                                        className={`nav-tab ${activeTab === tab.id ? 'active' : ''}`}
                                    >
                                        <span className="mr-1">{tab.icon}</span>
                                        {tab.label}
                                    </button>
                                ))}
                            </div>
                        </div>
                        
                        <div className="px-4 pb-6 space-y-4 max-h-[60vh] overflow-y-auto">
                            {activeTab === 'overview' && (
                                <StatsOverview 
                                    sessionStats={sessionStats}
                                    totalPoints={totalPoints}
                                    studyStreak={studyStreak}
                                />
                            )}
                            
                            {activeTab === 'calendar' && (
                                <ActivityCalendar dailyActivity={dailyActivity} />
                            )}
                            
                            {activeTab === 'charts' && (
                                <WeeklyChart weeklyData={getWeeklyData()} />
                            )}
                            
                            {activeTab === 'goals' && (
                                <Goals 
                                    sessionStats={sessionStats}
                                    studyStreak={studyStreak}
                                />
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // Badge Notification Component
        const BadgeNotification = ({ badge, isVisible, onClose }) => {
            useEffect(() => {
                if (isVisible && badge) {
                    createBadgeSound();
                }
            }, [isVisible, badge]);

            if (!isVisible || !badge) return null;

            return (
                <>
                    <div className="notification-overlay" onClick={onClose}></div>
                    <div className="badge-notification" onClick={onClose}>
                        <div className="text-8xl mb-4">{badge.emoji}</div>
                        <h2 className="text-3xl font-bold mb-2">¡Badge Desbloqueado!</h2>
                        <h3 className="text-2xl font-semibold mb-3 text-yellow-100">{badge.name}</h3>
                        <p className="text-lg mb-4">{badge.description}</p>
                        <div className="bg-white bg-opacity-20 rounded-lg p-4 mb-4">
                            <p className="text-xl font-bold text-yellow-200">+{badge.points} puntos bonus</p>
                        </div>
                        <p className="text-sm opacity-75">Toca para continuar</p>
                    </div>
                </>
            );
        };

        // Badges Gallery Component
        const BadgesGallery = ({ badges, unlockedBadges, onClose }) => {
            const badgesList = Object.values(BADGES);
            
            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-3xl max-w-md w-full max-h-[80vh] overflow-y-auto">
                        <div className="sticky top-0 bg-gradient-to-r from-amber-500 to-orange-500 text-white p-6 rounded-t-3xl">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <Award />
                                    <h2 className="text-xl font-bold">Galería de Logros</h2>
                                </div>
                                <button 
                                    onClick={onClose}
                                    className="text-white text-2xl font-bold hover:bg-white hover:bg-opacity-20 rounded-full w-8 h-8 flex items-center justify-center"
                                >
                                    <X />
                                </button>
                            </div>
                            <p className="text-sm opacity-90 mt-2">
                                {unlockedBadges.length}/{badgesList.length} logros desbloqueados
                            </p>
                        </div>
                        
                        <div className="p-6">
                            <div className="grid grid-cols-2 gap-4">
                                {badgesList.map(badge => {
                                    const isUnlocked = unlockedBadges.includes(badge.id);
                                    return (
                                        <div
                                            key={badge.id}
                                            className={`p-4 rounded-2xl border-2 text-center ${
                                                isUnlocked 
                                                    ? 'bg-gradient-to-br from-amber-100 to-orange-100 border-amber-300 badge-unlocked' 
                                                    : 'bg-gray-100 border-gray-300 badge-locked'
                                            }`}
                                        >
                                            <div className={`text-4xl mb-2 ${!isUnlocked ? 'filter grayscale' : ''}`}>
                                                {badge.emoji}
                                            </div>
                                            <h3 className={`font-semibold text-sm mb-1 ${isUnlocked ? 'text-amber-800' : 'text-gray-500'}`}>
                                                {badge.name}
                                            </h3>
                                            <p className={`text-xs mb-2 ${isUnlocked ? 'text-amber-600' : 'text-gray-400'}`}>
                                                {badge.description}
                                            </p>
                                            {isUnlocked && (
                                                <div className="text-xs font-bold text-green-600">
                                                    +{badge.points} pts
                                                </div>
                                            )}
                                            {!isUnlocked && (
                                                <div className="text-xs text-gray-400">
                                                    🔒 Bloqueado
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Completion Notification Component
        const CompletionNotification = ({ isVisible, onClose, level, points, streak, hasDoubleXP }) => {
            const motivationalMessages = [
                "¡Eres imparable! 🚀",
                "¡Cada minuto cuenta! ⭐",
                "¡Tu futuro yo te agradece! 🙏", 
                "¡Construyendo hábitos ganadores! 💪",
                "¡La constancia es tu superpoder! ✨",
                "¡Un paso más hacia el éxito! 🎯",
                "¡Tu disciplina está creciendo! 🌱"
            ];

            const message = motivationalMessages[Math.floor(Math.random() * motivationalMessages.length)];

            useEffect(() => {
                if (isVisible) {
                    createCompletionSound();
                }
            }, [isVisible]);

            if (!isVisible) return null;

            return (
                <>
                    <div className="notification-overlay" onClick={onClose}></div>
                    <div className={`notification ${hasDoubleXP ? 'double-xp-effect' : ''}`} onClick={onClose}>
                        <div className="text-6xl mb-4">🎉</div>
                        <h2 className="text-2xl font-bold mb-3">{message}</h2>
                        <div className="bg-white bg-opacity-20 rounded-lg p-4 mb-4">
                            <p className="text-lg mb-2">Completaste: <strong>{level.name}</strong></p>
                            <p className="text-xl font-bold text-yellow-200">
                                +{points} puntos ganados
                                {hasDoubleXP && <span className="text-sm ml-1">⚡ (x2)</span>}
                            </p>
                            <p className="text-sm mt-2">Racha actual: {streak} días 🔥</p>
                        </div>
                        <p className="text-lg font-semibold mb-4">🎁 {level.reward}</p>
                        <p className="text-sm opacity-75">Toca para continuar</p>
                    </div>
                </>
            );
        };

        const LazyStudentApp = () => {
            const [currentLevel, setCurrentLevel] = useState(1);
            const [timeLeft, setTimeLeft] = useState(120);
            const [totalTime, setTotalTime] = useState(120);
            const [isActive, setIsActive] = useState(false);
            const [studyStreak, setStudyStreak] = useState(() => {
                const saved = localStorage.getItem('studyStreak');
                return saved ? parseInt(saved) : 0;
            });
            const [totalPoints, setTotalPoints] = useState(() => {
                const saved = localStorage.getItem('totalPoints');
                return saved ? parseInt(saved) : 0;
            });
            const [sessionsToday, setSessionsToday] = useState(() => {
                const saved = localStorage.getItem('sessionsToday');
                const today = new Date().toDateString();
                const savedDate = localStorage.getItem('lastSessionDate');
                if (savedDate === today) {
                    return saved ? parseInt(saved) : 0;
                }
                return 0;
            });
            
            // Badge system states
            const [unlockedBadges, setUnlockedBadges] = useState(() => {
                const saved = localStorage.getItem('unlockedBadges');
                return saved ? JSON.parse(saved) : [];
            });
            const [showBadgeNotification, setShowBadgeNotification] = useState(false);
            const [newBadge, setNewBadge] = useState(null);
            const [showBadgesGallery, setShowBadgesGallery] = useState(false);
            
            // Stats and dashboard states
            const [showStatsDashboard, setShowStatsDashboard] = useState(false);
            const [dailyActivity, setDailyActivity] = useState(() => {
                const saved = localStorage.getItem('dailyActivity');
                return saved ? JSON.parse(saved) : {};
            });
            
            // Sound system states
            const [backgroundSound, setBackgroundSound] = useState(() => {
                const saved = localStorage.getItem('backgroundSound');
                return saved || null;
            });
            const [backgroundVolume, setBackgroundVolume] = useState(() => {
                const saved = localStorage.getItem('backgroundVolume');
                return saved ? parseFloat(saved) : 0.3;
            });
            const [tickSoundEnabled, setTickSoundEnabled] = useState(() => {
                const saved = localStorage.getItem('tickSoundEnabled');
                return saved ? JSON.parse(saved) : true;
            });
            const [showTickIndicator, setShowTickIndicator] = useState(false);
            
            // Power-up system states
            const [activePowerups, setActivePowerups] = useState(() => {
                const saved = localStorage.getItem('activePowerups');
                return saved ? JSON.parse(saved) : {};
            });
            const [showPowerupStore, setShowPowerupStore] = useState(false);
            const [showPowerupNotification, setShowPowerupNotification] = useState(false);
            const [newPowerup, setNewPowerup] = useState(null);
            const [focusMode, setFocusMode] = useState(false);
            const [doubleXPActive, setDoubleXPActive] = useState(false);
            const [speedBoostActive, setSpeedBoostActive] = useState(false);
            
            // Session tracking for badges
            const [sessionStats, setSessionStats] = useState(() => {
                const saved = localStorage.getItem('sessionStats');
                return saved ? JSON.parse(saved) : {
                    totalSessions: 0,
                    zombieSessions: 0,
                    turtleSessions: 0,
                    rabbitSessions: 0,
                    earlySessions: 0,
                    lateSessions: 0,
                    bestStreak: 0
                };
            });

            const [currentMantra, setCurrentMantra] = useState(0);
            const [showNotification, setShowNotification] = useState(false);
            const [startTime, setStartTime] = useState(null);
            const intervalRef = useRef(null);
            const tickIntervalRef = useRef(null);

            const mantras = [
                "Algo es mejor que nada ✨",
                "Soy más fuerte que mi resistencia inicial 💪",
                "Mi yo del futuro me va a agradecer 🙏",
                "No tengo que ser perfecto/a, solo consistente 🎯",
                "La pereza de hoy es la ansiedad de mañana 🌅"
            ];

            const levels = {
                1: { 
                    name: "Modo Zombie", 
                    time: 120, 
                    icon: "🧟‍♂️", 
                    color: "bg-gray-100 border-gray-300",
                    tasks: ["Leer 1 párrafo", "Ver 1 video de 5 min", "Repasar 5 flashcards"],
                    reward: "Tu snack favorito 🍫",
                    basePoints: 10
                },
                2: { 
                    name: "Modo Tortuga", 
                    time: 900, 
                    icon: "🐢", 
                    color: "bg-yellow-100 border-yellow-300",
                    tasks: ["15 min de estudio activo", "Hacer 1 ejercicio", "Resumir 1 página"],
                    reward: "20 min de entretenimiento 📱",
                    basePoints: 25
                },
                3: { 
                    name: "Modo Liebre", 
                    time: 2700, 
                    icon: "🐰", 
                    color: "bg-green-100 border-green-300",
                    tasks: ["45 min de estudio intenso", "5-10 ejercicios", "Crear mapa mental"],
                    reward: "Actividad que realmente disfrutes 🎉",
                    basePoints: 50
                }
            };

            const weeklyTips = [
                { day: "Lunes", tip: "Día del Reconocimiento - Solo organiza tu material 📚", icon: "🗂️" },
                { day: "Martes", tip: "Día de Acción Mínima - Elige tu nivel de energía 🎯", icon: "⚡" },
                { day: "Miércoles", tip: "Mantén el ritmo - Usa la técnica Pomodoro 🍅", icon: "⏰" },
                { day: "Jueves", tip: "Último empujón - ¡Ya casi terminas la semana! 💪", icon: "🚀" },
                { day: "Viernes", tip: "Día de Repaso Relajado - Celebra tus logros 🎉", icon: "🏆" },
                { day: "Sábado", tip: "Libertad total - Descansa o estudia 10 min si quieres 😊", icon: "🌟" },
                { day: "Domingo", tip: "Preparación mental para la nueva semana 🧠", icon: "💭" }
            ];

            const getCurrentDayTip = () => {
                const days = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
                const today = new Date().getDay();
                return weeklyTips.find(tip => tip.day === days[today]) || weeklyTips[0];
            };

            // Power-up functions
            const purchasePowerup = (powerupId) => {
                const powerup = POWERUPS[powerupId];
                if (totalPoints >= powerup.cost) {
                    setTotalPoints(prev => prev - powerup.cost);
                    setActivePowerups(prev => ({
                        ...prev,
                        [powerupId]: (prev[powerupId] || 0) + 1
                    }));
                    setNewPowerup(powerup);
                    setShowPowerupNotification(true);
                    setShowPowerupStore(false);
                }
            };

            const activatePowerup = (powerupId) => {
                if (activePowerups[powerupId] > 0) {
                    setActivePowerups(prev => ({
                        ...prev,
                        [powerupId]: prev[powerupId] - 1
                    }));
                    
                    switch(powerupId) {
                        case 'focus-mode':
                            setFocusMode(true);
                            break;
                        case 'double-xp':
                            setDoubleXPActive(true);
                            break;
                        case 'speed-boost':
                            setSpeedBoostActive(true);
                            // Reduce current timer by 25%
                            setTimeLeft(prev => Math.floor(prev * 0.75));
                            setTotalTime(prev => Math.floor(prev * 0.75));
                            break;
                    }
                    
                    setNewPowerup(POWERUPS[powerupId]);
                    setShowPowerupNotification(true);
                }
            };

            // Check for new badges
            const checkForNewBadges = (updatedStats, updatedStreak) => {
                const currentStats = {
                    ...updatedStats,
                    studyStreak: updatedStreak
                };

                const newlyUnlocked = [];
                
                Object.values(BADGES).forEach(badge => {
                    if (!unlockedBadges.includes(badge.id) && badge.condition(currentStats)) {
                        newlyUnlocked.push(badge);
                    }
                });

                if (newlyUnlocked.length > 0) {
                    setNewBadge(newlyUnlocked[0]);
                    setShowBadgeNotification(true);
                    
                    const newUnlockedIds = [...unlockedBadges, ...newlyUnlocked.map(b => b.id)];
                    setUnlockedBadges(newUnlockedIds);
                    
                    const bonusPoints = newlyUnlocked.reduce((sum, badge) => sum + badge.points, 0);
                    setTotalPoints(prev => prev + bonusPoints);
                    
                    if (navigator.vibrate) {
                        navigator.vibrate([100, 50, 100, 50, 200]);
                    }
                }
            };

            // Accurate points calculation with power-ups
            const calculatePoints = (level, completionPercentage = 100) => {
                const basePoints = levels[level].basePoints;
                const streakBonus = Math.min(studyStreak * 0.1, 2);
                const sessionBonus = sessionsToday * 0.05;
                const completionBonus = completionPercentage / 100;
                const doubleXPMultiplier = doubleXPActive ? 2 : 1;
                
                return Math.round(basePoints * (1 + streakBonus + sessionBonus) * completionBonus * doubleXPMultiplier);
            };

            // Background timer handling
            useEffect(() => {
                const handleBackgroundTime = (event) => {
                    if (isActive && startTime) {
                        const timeAwaySeconds = event.detail;
                        setTimeLeft(prev => Math.max(0, prev - timeAwaySeconds));
                    }
                };

                window.addEventListener('backgroundTimeUpdate', handleBackgroundTime);
                return () => window.removeEventListener('backgroundTimeUpdate', handleBackgroundTime);
            }, [isActive, startTime]);

            // Save to localStorage
            useEffect(() => {
                localStorage.setItem('studyStreak', studyStreak.toString());
                localStorage.setItem('totalPoints', totalPoints.toString());
                localStorage.setItem('sessionsToday', sessionsToday.toString());
                localStorage.setItem('lastSessionDate', new Date().toDateString());
                localStorage.setItem('unlockedBadges', JSON.stringify(unlockedBadges));
                localStorage.setItem('sessionStats', JSON.stringify(sessionStats));
                localStorage.setItem('dailyActivity', JSON.stringify(dailyActivity));
                localStorage.setItem('backgroundSound', backgroundSound || '');
                localStorage.setItem('backgroundVolume', backgroundVolume.toString());
                localStorage.setItem('tickSoundEnabled', JSON.stringify(tickSoundEnabled));
                localStorage.setItem('activePowerups', JSON.stringify(activePowerups));
            }, [studyStreak, totalPoints, sessionsToday, unlockedBadges, sessionStats, dailyActivity, backgroundSound, backgroundVolume, tickSoundEnabled, activePowerups]);

            // Start background sound when timer starts
            useEffect(() => {
                if (isActive && backgroundSound) {
                    createBackgroundSound(backgroundSound, backgroundVolume);
                } else if (!isActive && backgroundAudio) {
                    backgroundAudio.stop();
                    backgroundAudio = null;
                }
            }, [isActive, backgroundSound, backgroundVolume]);

            // Tick sound effect with speed boost
            useEffect(() => {
                if (isActive && tickSoundEnabled) {
                    const tickInterval = speedBoostActive ? 750 : 1000; // Faster tick with speed boost
                    tickIntervalRef.current = setInterval(() => {
                        createTickSound();
                        setShowTickIndicator(true);
                        setTimeout(() => setShowTickIndicator(false), 500);
                    }, tickInterval);
                } else {
                    if (tickIntervalRef.current) {
                        clearInterval(tickIntervalRef.current);
                        tickIntervalRef.current = null;
                    }
                }

                return () => {
                    if (tickIntervalRef.current) {
                        clearInterval(tickIntervalRef.current);
                    }
                };
            }, [isActive, tickSoundEnabled, speedBoostActive]);

            // Main timer logic with speed boost
            useEffect(() => {
                if (isActive && timeLeft > 0) {
                    const timerInterval = speedBoostActive ? 750 : 1000; // 25% faster with speed boost
                    intervalRef.current = setInterval(() => {
                        setTimeLeft(prev => {
                            if (prev <= 1) {
                                setIsActive(false);
                                handleTimerComplete();
                                return 0;
                            }
                            return prev - 1;
                        });
                    }, timerInterval);
                } else {
                    if (intervalRef.current) {
                        clearInterval(intervalRef.current);
                        intervalRef.current = null;
                    }
                }

                return () => {
                    if (intervalRef.current) {
                        clearInterval(intervalRef.current);
                    }
                };
            }, [isActive, timeLeft, speedBoostActive]);

            const handleTimerComplete = () => {
                const completionPercentage = 100;
                const earnedPoints = calculatePoints(currentLevel, completionPercentage);
                
                // Stop background sound
                if (backgroundAudio) {
                    backgroundAudio.stop();
                    backgroundAudio = null;
                }
                
                // Deactivate single-use power-ups
                setFocusMode(false);
                setDoubleXPActive(false);
                setSpeedBoostActive(false);
                
                // Update basic stats
                const newStreak = studyStreak + 1;
                setStudyStreak(newStreak);
                setTotalPoints(prev => prev + earnedPoints);
                setSessionsToday(prev => prev + 1);
                
                // Update daily activity
                const today = new Date().toDateString();
                setDailyActivity(prev => ({
                    ...prev,
                    [today]: (prev[today] || 0) + 1
                }));
                
                // Update session stats for badges
                const currentHour = new Date().getHours();
                const updatedStats = {
                    ...sessionStats,
                    totalSessions: sessionStats.totalSessions + 1,
                    zombieSessions: currentLevel === 1 ? sessionStats.zombieSessions + 1 : sessionStats.zombieSessions,
                    turtleSessions: currentLevel === 2 ? sessionStats.turtleSessions + 1 : sessionStats.turtleSessions,
                    rabbitSessions: currentLevel === 3 ? sessionStats.rabbitSessions + 1 : sessionStats.rabbitSessions,
                    earlySessions: currentHour < 8 ? sessionStats.earlySessions + 1 : sessionStats.earlySessions,
                    lateSessions: currentHour >= 20 ? sessionStats.lateSessions + 1 : sessionStats.lateSessions,
                    bestStreak: Math.max(sessionStats.bestStreak || 0, newStreak)
                };
                setSessionStats(updatedStats);
                
                // Check for new badges
                setTimeout(() => {
                    checkForNewBadges(updatedStats, newStreak);
                }, 1000);
                
                setShowNotification(true);
                
                // Vibrate
                if (navigator.vibrate) {
                    navigator.vibrate([300, 100, 300, 100, 300]);
                }
            };

            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            };

            const startTimer = async () => {
                initAudioContext();
                
                setIsActive(true);
                setStartTime(Date.now());
                
                try {
                    if ('wakeLock' in navigator) {
                        await navigator.wakeLock.request('screen');
                    }
                } catch (err) {
                    console.log('Wake lock failed:', err);
                }
            };

            const pauseTimer = () => {
                setIsActive(false);
                setStartTime(null);
                
                if (backgroundAudio) {
                    backgroundAudio.stop();
                    backgroundAudio = null;
                }
            };

            const resetTimer = () => {
                setIsActive(false);
                setStartTime(null);
                setTimeLeft(levels[currentLevel].time);
                setTotalTime(levels[currentLevel].time);
                
                // Reset power-ups
                setFocusMode(false);
                setDoubleXPActive(false);
                setSpeedBoostActive(false);
                
                if (backgroundAudio) {
                    backgroundAudio.stop();
                    backgroundAudio = null;
                }
            };

            const changeLevel = (level) => {
                setCurrentLevel(level);
                setTimeLeft(levels[level].time);
                setTotalTime(levels[level].time);
                setIsActive(false);
                setStartTime(null);
                
                // Reset power-ups
                setFocusMode(false);
                setDoubleXPActive(false);
                setSpeedBoostActive(false);
                
                if (backgroundAudio) {
                    backgroundAudio.stop();
                    backgroundAudio = null;
                }
            };

            const getEnergyLevel = () => {
                if (currentLevel === 1) return <Battery className="w-5 h-5 text-gray-500" />;
                if (currentLevel === 2) return <Zap className="w-5 h-5 text-yellow-500" />;
                return <Heart className="w-5 h-5 text-red-500" />;
            };

            const getProgressPercentage = () => {
                return ((totalTime - timeLeft) / totalTime) * 100;
            };

            const todayTip = getCurrentDayTip();
            const hasActivePowerups = Object.values(activePowerups).some(count => count > 0);

            return (
                <div className="min-h-screen bg-gradient-to-br from-purple-100 to-pink-100 p-4">
                    <div className="max-w-md mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden">
                        
                        {/* Focus Mode Overlay */}
                        <FocusMode 
                            isActive={focusMode} 
                            onExit={() => setFocusMode(false)} 
                        />
                        
                        {/* Header */}
                        <div className="bg-gradient-to-r from-purple-500 to-pink-500 p-6 text-white">
                            <div className="flex items-center justify-between">
                                <div>
                                    <h1 className="text-xl font-bold">📚 Estudiante Perezoso</h1>
                                    <p className="text-sm opacity-90">v6.0 - Con Power-ups!</p>
                                </div>
                                <div className="text-right">
                                    <div className="flex items-center gap-2">
                                        <Trophy />
                                        <span className="font-bold">{totalPoints.toLocaleString()}pts</span>
                                    </div>
                                    <div className="flex items-center gap-2 mt-1">
                                        <Star />
                                        <span className="text-sm">{studyStreak} días</span>
                                    </div>
                                    <div className="text-xs opacity-75 mt-1">
                                        {sessionsToday} sesiones hoy
                                    </div>
                                </div>
                            </div>
                            
                            {/* Quick access buttons */}
                            <div className="mt-4 flex items-center justify-between gap-2">
                                <button
                                    onClick={() => setShowBadgesGallery(true)}
                                    className="flex items-center gap-2 bg-white bg-opacity-20 rounded-full px-3 py-2 text-sm hover:bg-opacity-30 transition-all"
                                >
                                    <Award className="w-4 h-4" />
                                    <span>Logros ({unlockedBadges.length}/{Object.keys(BADGES).length})</span>
                                </button>
                                
                                <button
                                    onClick={() => setShowStatsDashboard(true)}
                                    className="flex items-center gap-2 bg-white bg-opacity-20 rounded-full px-3 py-2 text-sm hover:bg-opacity-30 transition-all"
                                >
                                    <BarChart className="w-4 h-4" />
                                    <span>Stats</span>
                                </button>
                                
                                <button
                                    onClick={() => setShowPowerupStore(true)}
                                    className={`flex items-center gap-2 bg-white bg-opacity-20 rounded-full px-3 py-2 text-sm hover:bg-opacity-30 transition-all ${hasActivePowerups ? 'powerup-active' : ''}`}
                                >
                                    <ShoppingBag className="w-4 h-4" />
                                    <span>Power-ups</span>
                                    {hasActivePowerups && (
                                        <span className="bg-pink-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
                                            {Object.values(activePowerups).reduce((sum, count) => sum + count, 0)}
                                        </span>
                                    )}
                                </button>
                                
                                {unlockedBadges.length > 0 && (
                                    <div className="flex gap-1">
                                        {unlockedBadges.slice(-3).map(badgeId => (
                                            <div key={badgeId} className="text-lg">
                                                {BADGES[badgeId]?.emoji}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>

                            {/* Active Power-ups Display */}
                            {(doubleXPActive || speedBoostActive || focusMode) && (
                                <div className="mt-3 flex gap-2 flex-wrap">
                                    {doubleXPActive && (
                                        <span className="text-xs bg-yellow-500 text-white px-2 py-1 rounded-full">
                                            ⚡ Doble XP
                                        </span>
                                    )}
                                    {speedBoostActive && (
                                        <span className="text-xs bg-blue-500 text-white px-2 py-1 rounded-full speed-boost-indicator">
                                            🚀 Turbo
                                        </span>
                                    )}
                                    {focusMode && (
                                        <span className="text-xs bg-purple-500 text-white px-2 py-1 rounded-full">
                                            🎯 Focus
                                        </span>
                                    )}
                                </div>
                            )}

                            {/* Sound Panel */}
                            <SoundPanel 
                                backgroundSound={backgroundSound}
                                setBackgroundSound={setBackgroundSound}
                                backgroundVolume={backgroundVolume}
                                setBackgroundVolume={setBackgroundVolume}
                                tickSoundEnabled={tickSoundEnabled}
                                setTickSoundEnabled={setTickSoundEnabled}
                                isTimerActive={isActive}
                            />
                        </div>

                        {/* Tip del día */}
                        <div className="p-4 bg-blue-50 border-l-4 border-blue-400">
                            <div className="flex items-center gap-2">
                                <span className="text-2xl">{todayTip.icon}</span>
                                <div>
                                    <h3 className="font-semibold text-blue-800">{todayTip.day}</h3>
                                    <p className="text-sm text-blue-600">{todayTip.tip}</p>
                                </div>
                            </div>
                        </div>

                        {/* Quick Power-up Activation */}
                        {hasActivePowerups && !isActive && (
                            <div className="p-4 bg-pink-50 border-l-4 border-pink-400">
                                <h3 className="font-semibold text-pink-800 mb-2">⚡ Power-ups Disponibles:</h3>
                                <div className="flex gap-2 flex-wrap">
                                    {Object.entries(activePowerups).map(([powerupId, count]) => {
                                        if (count > 0) {
                                            const powerup = POWERUPS[powerupId];
                                            return (
                                                <button
                                                    key={powerupId}
                                                    onClick={() => activatePowerup(powerupId)}
                                                    className="flex items-center gap-1 bg-pink-500 text-white px-3 py-1 rounded-full text-sm hover:bg-pink-600 transition-all"
                                                >
                                                    <span>{powerup.emoji}</span>
                                                    <span>{powerup.name}</span>
                                                    <span className="bg-white text-pink-500 rounded-full w-5 h-5 text-xs flex items-center justify-center">
                                                        {count}
                                                    </span>
                                                </button>
                                            );
                                        }
                                        return null;
                                    })}
                                </div>
                            </div>
                        )}

                        {/* Selector de nivel */}
                        <div className="p-6">
                            <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                                {getEnergyLevel()}
                                ¿Cómo te sientes hoy?
                            </h2>
                            <div className="grid grid-cols-1 gap-3">
                                {Object.entries(levels).map(([key, level]) => {
                                    const estimatedPoints = calculatePoints(parseInt(key));
                                    return (
                                        <button
                                            key={key}
                                            onClick={() => changeLevel(parseInt(key))}
                                            className={`p-4 rounded-2xl border-2 transition-all duration-200 ${
                                                currentLevel === parseInt(key) 
                                                    ? level.color + ' border-current shadow-lg transform scale-105' 
                                                    : 'bg-gray-50 border-gray-200 hover:bg-gray-100'
                                            }`}
                                        >
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center gap-3">
                                                    <span className="text-2xl">{level.icon}</span>
                                                    <div className="text-left">
                                                        <h3 className="font-semibold">{level.name}</h3>
                                                        <p className="text-sm text-gray-600">{Math.floor(level.time / 60)} minutos</p>
                                                    </div>
                                                </div>
                                                <div className="text-right">
                                                    <p className="text-sm font-bold text-green-600">
                                                        ~{estimatedPoints} pts
                                                        {doubleXPActive && <span className="text-yellow-600 ml-1">⚡</span>}
                                                    </p>
                                                    <p className="text-xs text-gray-500">estimado</p>
                                                </div>
                                            </div>
                                        </button>
                                    );
                                })}
                            </div>
                        </div>

                        {/* Timer */}
                        <div className="p-6">
                            <div className="text-center mb-6">
                                <div className="relative inline-block">
                                    <div className="absolute inset-0 bg-gradient-to-br from-purple-400 to-pink-400 rounded-full p-8">
                                        <ProgressRing percentage={getProgressPercentage()} />
                                    </div>
                                    <div className="relative bg-gradient-to-br from-purple-400 to-pink-400 rounded-full p-8 flex items-center justify-center">
                                        <div className="absolute">
                                            <div className={`text-4xl font-mono text-white font-bold ${speedBoostActive ? 'speed-boost-indicator' : ''}`}>
                                                {formatTime(timeLeft)}
                                            </div>
                                            {showTickIndicator && (
                                                <div className="tick-indicator">♪</div>
                                            )}
                                        </div>
                                        <ProgressRing percentage={getProgressPercentage()} />
                                    </div>
                                </div>
                                <p className="text-gray-600 mb-2 mt-4">
                                    {levels[currentLevel].name} {levels[currentLevel].icon}
                                </p>
                                {isActive && (
                                    <div className="space-y-1">
                                        <p className="text-sm text-purple-600">
                                            ⏰ Continúa aunque cierres la app
                                        </p>
                                        {backgroundSound && (
                                            <p className="text-xs text-green-600">
                                                🎵 Sonido ambiente activo
                                            </p>
                                        )}
                                        {tickSoundEnabled && (
                                            <p className="text-xs text-blue-600">
                                                🔔 Tick del reloj habilitado
                                            </p>
                                        )}
                                    </div>
                                )}
                            </div>

                            {/* Controles */}
                            <div className="flex justify-center gap-4 mb-6">
                                <button
                                    onClick={isActive ? pauseTimer : startTimer}
                                    className="flex items-center gap-2 bg-gradient-to-r from-green-500 to-blue-500 text-white px-6 py-3 rounded-full hover:shadow-lg transition-all duration-200 transform hover:scale-105"
                                >
                                    {isActive ? <Pause /> : <Play />}
                                    {isActive ? 'Pausar' : 'Empezar'}
                                </button>
                                <button
                                    onClick={resetTimer}
                                    className="flex items-center gap-2 bg-gray-500 text-white px-6 py-3 rounded-full hover:shadow-lg transition-all duration-200 transform hover:scale-105"
                                >
                                    <RotateCcw />
                                    Reset
                                </button>
                            </div>

                            {/* Tareas del nivel actual */}
                            <div className="bg-gray-50 rounded-2xl p-4 mb-4">
                                <h3 className="font-semibold mb-3 flex items-center gap-2">
                                    <Coffee />
                                    Tareas de hoy:
                                </h3>
                                <ul className="space-y-2">
                                    {levels[currentLevel].tasks.map((task, index) => (
                                        <li key={index} className="flex items-center gap-2">
                                            <div className="w-2 h-2 bg-purple-400 rounded-full"></div>
                                            <span className="text-sm">{task}</span>
                                        </li>
                                    ))}
                                </ul>
                                <div className="mt-3 p-3 bg-yellow-100 rounded-lg">
                                    <p className="text-sm font-medium text-yellow-800">
                                        🎁 Recompensa: {levels[currentLevel].reward}
                                    </p>
                                </div>
                            </div>

                            {/* Mantra motivacional */}
                            <div className="bg-gradient-to-r from-purple-100 to-pink-100 rounded-2xl p-4 text-center">
                                <button
                                    onClick={() => setCurrentMantra((currentMantra + 1) % mantras.length)}
                                    className="w-full"
                                >
                                    <p className="text-sm font-medium text-purple-800 mb-2">💭 Mantra del momento:</p>
                                    <p className="text-lg font-semibold text-purple-900">
                                        {mantras[currentMantra]}
                                    </p>
                                    <p className="text-xs text-purple-600 mt-2">Toca para cambiar</p>
                                </button>
                            </div>
                        </div>

                        {/* Completion Notification */}
                        <CompletionNotification 
                            isVisible={showNotification}
                            onClose={() => setShowNotification(false)}
                            level={levels[currentLevel]}
                            points={calculatePoints(currentLevel)}
                            streak={studyStreak}
                            hasDoubleXP={doubleXPActive}
                        />

                        {/* Badge Notification */}
                        <BadgeNotification 
                            badge={newBadge}
                            isVisible={showBadgeNotification}
                            onClose={() => {
                                setShowBadgeNotification(false);
                                setNewBadge(null);
                            }}
                        />

                        {/* Power-up Notification */}
                        <PowerupNotification 
                            powerup={newPowerup}
                            isVisible={showPowerupNotification}
                            onClose={() => {
                                setShowPowerupNotification(false);
                                setNewPowerup(null);
                            }}
                        />

                        {/* Badges Gallery */}
                        {showBadgesGallery && (
                            <BadgesGallery 
                                badges={BADGES}
                                unlockedBadges={unlockedBadges}
                                onClose={() => setShowBadgesGallery(false)}
                            />
                        )}

                        {/* Statistics Dashboard */}
                        {showStatsDashboard && (
                            <StatsDashboard 
                                onClose={() => setShowStatsDashboard(false)}
                                sessionStats={sessionStats}
                                totalPoints={totalPoints}
                                studyStreak={studyStreak}
                                dailyActivity={dailyActivity}
                            />
                        )}

                        {/* Power-up Store */}
                        {showPowerupStore && (
                            <PowerupStore 
                                onClose={() => setShowPowerupStore(false)}
                                totalPoints={totalPoints}
                                activePowerups={activePowerups}
                                onPurchase={purchasePowerup}
                            />
                        )}

                        {/* Footer */}
                        <div className="p-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white text-center">
                            <p className="text-sm opacity-90">
                                "Tu yo del futuro te va a amar por cada pequeño paso" 💜
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<LazyStudentApp />, document.getElementById('root'));
    </script>
</body>
</html>
                        const createPowerupSound = () => {
            const ctx = initAudioContext();
            
            // Powerful powerup sound
            const notes = [261.63, 329.63, 392.00, 523.25, 659.25]; // C4, E4, G4, C5, E5
            
            notes.forEach((freq, index) => {
                setTimeout(() => {
                    const oscillator = ctx.createOscillator();
                    const gainNode = ctx.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(ctx.destination);
                    
                    oscillator.frequency.setValueAtTime(freq, ctx.currentTime);
                    oscillator.type = 'sawtooth';
                    
                    gainNode.gain.setValueAtTime(0.2, ctx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.6);
                    
                    oscillator.start(ctx.currentTime);
                    oscillator.stop(ctx.currentTime + 0.6);
                }, index * 80);
            });
        };

        // Background sound generation functions (from previous phase)
        const createBackgroundSound = (type, volume = 0.3) => {
            const ctx = initAudioContext();
            
            if (backgroundAudio) {
                backgroundAudio.stop();
            }
            
            switch(type) {
                case 'rain':
                    return createRainSound(ctx, volume);
                case 'coffee':
                    return createCoffeeShopSound(ctx, volume);
                case 'forest':
                    return createForestSound(ctx, volume);
                case 'ocean':
                    return createOceanSound(ctx, volume);
                case 'lofi':
                    return createLoFiSound(ctx, volume);
                default:
                    return null;
            }
        };

        const createRainSound = (ctx, volume) => {
            const bufferSize = ctx.sampleRate * 2;
            const noiseBuffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
            const output = noiseBuffer.getChannelData(0);
            
            for (let i = 0; i < bufferSize; i++) {
                output[i] = Math.random() * 2 - 1;
            }
            
            const whiteNoise = ctx.createBufferSource();
            whiteNoise.buffer = noiseBuffer;
            whiteNoise.loop = true;
            
            const bandpass = ctx.createBiquadFilter();
            bandpass.type = 'bandpass';
            bandpass.frequency.value = 1000;
            bandpass.Q.value = 0.3;
            
            const gainNode = ctx.createGain();
            gainNode.gain.value = volume * 0.5;
            
            whiteNoise.connect(bandpass);
            bandpass.connect(gainNode);
            gainNode.connect(ctx.destination);
            
            whiteNoise.start();
            backgroundAudio = whiteNoise;
            
            return whiteNoise;
        };

        const createCoffeeShopSound = (ctx, volume) => {
            const bufferSize = ctx.sampleRate * 2;
            const noiseBuffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
            const output = noiseBuffer.getChannelData(0);
            
            let lastOut = 0;
            for (let i = 0; i < bufferSize; i++) {
                const white = Math.random() * 2 - 1;
                output[i] = (lastOut + (0.02 * white)) / 1.02;
                lastOut = output[i];
                output[i] *= 3.5;
            }
            
            const brownNoise = ctx.createBufferSource();
            brownNoise.buffer = noiseBuffer;
            brownNoise.loop = true;
            
            const lowpass = ctx.createBiquadFilter();
            lowpass.type = 'lowpass';
            lowpass.frequency.value = 300;
            
            const gainNode = ctx.createGain();
            gainNode.gain.value = volume * 0.4;
            
            brownNoise.connect(lowpass);
            lowpass.connect(gainNode);
            gainNode.connect(ctx.destination);
            
            brownNoise.start();
            backgroundAudio = brownNoise;
            
            return brownNoise;
        };

        const createForestSound = (ctx, volume) => {
            const bufferSize = ctx.sampleRate * 4;
            const noiseBuffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
            const output = noiseBuffer.getChannelData(0);
            
            for (let i = 0; i < bufferSize; i++) {
                output[i] = (Math.random() * 2 - 1) * Math.sin(i * 0.001);
            }
            
            const windNoise = ctx.createBufferSource();
            windNoise.buffer = noiseBuffer;
            windNoise.loop = true;
            
            const bandpass = ctx.createBiquadFilter();
            bandpass.type = 'bandpass';
            bandpass.frequency.value = 200;
            bandpass.Q.value = 0.5;
            
            const gainNode = ctx.createGain();
            gainNode.gain.value = volume * 0.3;
            
            windNoise.connect(bandpass);
            bandpass.connect(gainNode);
            gainNode.connect(ctx.destination);
            
            windNoise.start();
            backgroundAudio = windNoise;
            
            return windNoise;
        };

        const createOceanSound = (ctx, volume) => {
            const gainNode = ctx.createGain();
            gainNode.gain.value = volume * 0.4;
            gainNode.connect(ctx.destination);
            
            const oscillators = [];
            const frequencies = [40, 60, 80, 100];
            
            frequencies.forEach(freq => {
                const osc = ctx.createOscillator();
                const oscGain = ctx.createGain();
                
                osc.type = 'sine';
                osc.frequency.value = freq;
                oscGain.gain.value = 0.1;
                
                osc.frequency.setValueAtTime(freq, ctx.currentTime);
                setInterval(() => {
                    if (osc.frequency) {
                        osc.frequency.exponentialRampToValueAtTime(
                            freq + (Math.random() - 0.5) * 20, 
                            ctx.currentTime + 2
                        );
                    }
                }, 2000);
                
                osc.connect(oscGain);
                oscGain.connect(gainNode);
                osc.start();
                
                oscillators.push(osc);
            });
            
            backgroundAudio = {
                stop: () => oscillators.forEach(osc => osc.stop())
            };
            
            return backgroundAudio;
        };

        const createLoFiSound = (ctx, volume) => {
            const gainNode = ctx.createGain();
            gainNode.gain.value = volume * 0.3;
            gainNode.connect(ctx.destination);
            
            const createBeat = () => {
                const osc = ctx.createOscillator();
                const oscGain = ctx.createGain();
                
                osc.type = 'sine';
                osc.frequency.value = 60;
                oscGain.gain.value = 0.3;
                
                osc.connect(oscGain);
                oscGain.connect(gainNode);
                
                oscGain.gain.setValueAtTime(0.3, ctx.currentTime);
                oscGain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                
                osc.start();
                osc.stop(ctx.currentTime + 0.3);
            };
            
            const beatInterval = setInterval(createBeat, 800);
            
            backgroundAudio = {
                stop: () => clearInterval(beatInterval)
            };
            
            return backgroundAudio;
        };

        // Power-ups System
        const POWERUPS = {
            'focus-mode': {
                id: 'focus-mode',
                name: 'Modo Focus',
                description: 'Bloquea distracciones y crea un ambiente de concentración total',
                emoji: '🎯',
                cost: 100,
                duration: null, // Dura toda la sesión
                effect: 'Pantalla enfocada sin distracciones'
            },
            'double-xp': {
                id: 'double-xp',
                name: 'Doble XP',
                description: 'Duplica los puntos ganados en tu próxima sesión',
                emoji: '⚡',
                cost: 150,
                duration: 1, // 1 sesión
                effect: 'Puntos x2 en la siguiente sesión'
            },
            'streak-saver': {
                id: 'streak-saver',
                name: 'Salvavidas',
                description: 'Protege tu racha de un día perdido',
                emoji: '🛡️',
                cost: 200,
                duration: null, // Se usa automáticamente
                effect: 'Mantiene tu racha aunque falles un día'
            },
            'speed-boost': {
                id: 'speed-boost',
                name: 'Turbo Boost',
                description: 'Reduce el tiempo de estudio en 25% con mismos puntos',
                emoji: '🚀',
                cost: 120,
                duration: 1, // 1 sesión
                effect: 'Timer 25% más rápido, puntos normales'
            },
            'zen-master': {
                id: 'zen-master',
                name: 'Maestro Zen',
                description: 'Sonidos premium y ambiente perfecto para estudiar',
                emoji: '🧘‍♀️',
                cost: 80,
                duration: 1, // 1 sesión
                effect: 'Sonidos premium + efectos de relajación'
            }
        };

        // Lucide Icons
        const Play = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <polygon points="5,3 19,12 5,21" />
            </svg>
        );
        
        const Pause = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <rect x="6" y="4" width="4" height="16" />
                <rect x="14" y="4" width="4" height="16" />
            </svg>
        );
        
        const RotateCcw = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
                <path d="M3 3v5h5" />
            </svg>
        );
        
        const Trophy = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6" />
                <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18" />
                <path d="M4 22h16" />
                <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22" />
                <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22" />
                <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z" />
            </svg>
        );
        
        const Star = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26" />
            </svg>
        );
        
        const Coffee = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <path d="M17 8h1a4 4 0 1 1 0 8h-1" />
                <path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z" />
                <line x1="6" y1="2" x2="6" y2="4" />
                <line x1="10" y1="2" x2="10" y2="4" />
                <line x1="14" y1="2" x2="14" y2="4" />
            </svg>
        );
        
        const Battery = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <rect width="16" height="10" x="2" y="7" rx="2" ry="2" />
                <line x1="22" y1="11" x2="22" y2="13" />
            </svg>
        );
        
        const Zap = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <polygon points="13,2 3,14 12,14 11,22 21,10 12,10" />
            </svg>
        );
        
        const Heart = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" />
            </svg>
        );

        const Award = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <circle cx="12" cy="8" r="6" />
                <path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11" />
            </svg>
        );

        const BarChart = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <line x1="12" y1="20" x2="12" y2="10" />
                <line x1="18" y1="20" x2="18" y2="4" />
                <line x1="6" y1="20" x2="6" y2="16" />
            </svg>
        );

        const Calendar = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <rect width="18" height="18" x="3" y="4" rx="2" ry="2" />
                <line x1="16" y1="2" x2="16" y2="6" />
                <line x1="8" y1="2" x2="8" y2="6" />
                <line x1="3" y1="10" x2="21" y2="10" />
            </svg>
        );

        const Target = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" />
                <circle cx="12" cy="12" r="6" />
                <circle cx="12" cy="12" r="2" />
            </svg>
        );

        const Volume2 = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <polygon points="11,5 6,9 2,9 2,15 6,15 11,19" />
                <path d="M15.54 8.46a5 5 0 0 1 0 7.07" />
                <path d="M19.07 4.93a10 10 0 0 1 0 14.14" />
            </svg>
        );

        const VolumeX = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <polygon points="11,5 6,9 2,9 2,15 6,15 11,19" />
                <line x1="22" y1="9" x2="16" y2="15" />
                <line x1="16" y1="9" x2="22" y2="15" />
            </svg>
        );

        const Music = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <path d="M9 18V5l12-2v13" />
                <circle cx="6" cy="18" r="3" />
                <circle cx="18" cy="16" r="3" />
            </svg>
        );

        const ShoppingBag = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z" />
                <line x1="3" y1="6" x2="21" y2="6" />
                <path d="M16 10a4 4 0 0 1-8 0" />
            </svg>
        );

        const X = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <line x1="18" y1="6" x2="6" y2="18" />
                <line x1="6" y1="6" x2="18" y2="18" />
            </svg>
        );

        // Progress Ring Component
        const ProgressRing = ({ percentage, size = 160 }) => {
            const radius = 70;
            const circumference = radius * 2 * Math.PI;
            const strokeDashoffset = circumference - (percentage / 100) * circumference;
            
            return (
                <svg width={size} height={size} className="progress-ring">
                    <circle
                        stroke="rgba(255,255,255,0.2)"
                        fill="transparent"
                        strokeWidth="8"
                        r={radius}
                        cx={size/2}
                        cy={size/2}
                    />
                    <circle
                        stroke="white"
                        fill="transparent"
                        strokeWidth="8"
                        strokeLinecap="round"
                        r={radius}
                        cx={size/2}
                        cy={size/2}
                        className="progress-ring-circle"
                        style={{
                            strokeDasharray: circumference,
                            strokeDashoffset: strokeDashoffset,
                        }}
                    />
                </svg>
            );
        };

        // Audio Visualizer Component
        const AudioVisualizer = ({ isPlaying }) => {
            if (!isPlaying) return null;
            
            return (
                <div className="audio-visualizer">
                    {[...Array(8)].map((_, i) => (
                        <div key={i} className="visualizer-bar" />
                    ))}
                </div>
            );
        };

        // Sound Control Component
        const SoundControl = ({ icon, label, isActive, onClick, volume, onVolumeChange, showVisualizer = false }) => {
            return (
                <div className={`sound-control ${isActive ? 'active' : ''}`}>
                    <button onClick={onClick} className="flex items-center gap-2">
                        {icon}
                        <span className="text-sm font-medium text-white">{label}</span>
                    </button>
                    {isActive && (
                        <>
                            <input
                                type="range"
                                min="0"
                                max="100"
                                value={volume * 100}
                                onChange={(e) => onVolumeChange(e.target.value / 100)}
                                className="volume-slider"
                            />
                            {showVisualizer && <AudioVisualizer isPlaying={isActive} />}
                        </>
                    )}
                </div>
            );
        };

        // Sound Panel Component
        const SoundPanel = ({ 
            backgroundSound, 
            setBackgroundSound, 
            backgroundVolume, 
            setBackgroundVolume,
            tickSoundEnabled,
            setTickSoundEnabled,
            isTimerActive 
        }) => {
            const backgroundSounds = [
                { id: 'rain', label: 'Lluvia', icon: '🌧️' },
                { id: 'coffee', label: 'Café', icon: '☕' },
                { id: 'forest', label: 'Bosque', icon: '🌲' },
                { id: 'ocean', label: 'Océano', icon: '🌊' },
                { id: 'lofi', label: 'Lo-Fi', icon: '🎵' }
            ];

            const toggleBackgroundSound = (soundId) => {
                if (backgroundSound === soundId) {
                    if (backgroundAudio) {
                        backgroundAudio.stop();
                        backgroundAudio = null;
                    }
                    setBackgroundSound(null);
                } else {
                    if (backgroundAudio) {
                        backgroundAudio.stop();
                    }
                    createBackgroundSound(soundId, backgroundVolume);
                    setBackgroundSound(soundId);
                }
            };

            const handleVolumeChange = (newVolume) => {
                setBackgroundVolume(newVolume);
                if (backgroundSound && backgroundAudio) {
                    backgroundAudio.stop();
                    createBackgroundSound(backgroundSound, newVolume);
                }
            };

            return (
                <div className="sound-panel">
                    <h3 className="text-white font-semibold mb-4 flex items-center gap-2">
                        <Music />
                        Ambiente de Estudio
                    </h3>
                    
                    <div className="space-y-3">
                        <SoundControl
                            icon={tickSoundEnabled ? <Volume2 /> : <VolumeX />}
                            label="Tick del Reloj"
                            isActive={tickSoundEnabled}
                            onClick={() => setTickSoundEnabled(!tickSoundEnabled)}
                            volume={0.5}
                            onVolumeChange={() => {}}
                        />
                        
                        <div className="space-y-2">
                            <p className="text-white text-sm opacity-75">Sonidos de Fondo:</p>
                            <div className="grid grid-cols-2 gap-2">
                                {backgroundSounds.map(sound => (
                                    <SoundControl
                                        key={sound.id}
                                        icon={<span className="text-lg">{sound.icon}</span>}
                                        label={sound.label}
                                        isActive={backgroundSound === sound.id}
                                        onClick={() => toggleBackgroundSound(sound.id)}
                                        volume={backgroundVolume}
                                        onVolumeChange={handleVolumeChange}
                                        showVisualizer={backgroundSound === sound.id}
                                    />
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Power-up Store Component
        const PowerupStore = ({ onClose, totalPoints, activePowerups, onPurchase }) => {
            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-3xl max-w-md w-full max-h-[80vh] overflow-y-auto">
                        <div className="sticky top-0 bg-gradient-to-r from-pink-500 to-purple-500 text-white p-6 rounded-t-3xl">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <ShoppingBag />
                                    <h2 className="text-xl font-bold">Tienda Power-ups</h2>
                                </div>
                                <button 
                                    onClick={onClose}
                                    className="text-white text-2xl font-bold hover:bg-white hover:bg-opacity-20 rounded-full w-8 h-8 flex items-center justify-center"
                                >
                                    <X />
                                </button>
                            </div>
                            <div className="flex items-center gap-2 mt-2">
                                <Trophy className="w-4 h-4" />
                                <span className="text-sm">{totalPoints.toLocaleString()} puntos disponibles</span>
                            </div>
                        </div>
                        
                        <div className="p-6">
                            <div className="space-y-4">
                                {Object.values(POWERUPS).map(powerup => {
                                    const isOwned = activePowerups[powerup.id] > 0;
                                    const canAfford = totalPoints >= powerup.cost;
                                    
                                    return (
                                        <div
                                            key={powerup.id}
                                            className={`p-4 rounded-2xl border-2 ${
                                                isOwned 
                                                    ? 'bg-gradient-to-br from-pink-100 to-purple-100 border-pink-300' 
                                                    : canAfford
                                                    ? 'bg-gray-50 border-gray-200 hover:bg-gray-100'
                                                    : 'bg-gray-100 border-gray-300 opacity-50'
                                            }`}
                                        >
                                            <div className="flex items-center justify-between mb-2">
                                                <div className="flex items-center gap-3">
                                                    <span className="text-3xl">{powerup.emoji}</span>
                                                    <div>
                                                        <h3 className="font-bold text-lg">{powerup.name}</h3>
                                                        {isOwned && (
                                                            <span className="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">
                                                                Tienes {activePowerups[powerup.id]}
                                                            </span>
                                                        )}
                                                    </div>
                                                </div>
                                                <div className="text-right">
                                                    <div className="text-lg font-bold text-purple-600">
                                                        {powerup.cost} pts
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <p className="text-sm text-gray-600 mb-3">
                                                {powerup.description}
                                            </p>
                                            
                                            <div className="bg-blue-50 rounded-lg p-2 mb-3">
                                                <p className="text-xs text-blue-800 font-medium">
                                                    💫 {powerup.effect}
                                                </p>
                                            </div>
                                            
                                            <button
                                                onClick={() => onPurchase(powerup.id)}
                                                disabled={!canAfford}
                                                className={`w-full py-2 px-4 rounded-xl font-semibold transition-all ${
                                                    canAfford
                                                        ? 'bg-gradient-to-r from-pink-500 to-purple-500 text-white hover:shadow-lg transform hover:scale-105'
                                                        : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                                }`}
                                            >
                                                {canAfford ? 'Comprar' : 'Puntos insuficientes'}
                                            </button>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Power-up Notification Component
        const PowerupNotification = ({ powerup, isVisible, onClose }) => {
            useEffect(() => {
                if (isVisible && powerup) {
                    createPowerupSound();
                }
            }, [isVisible, powerup]);

            if (!isVisible || !powerup) return null;

            return (
                <>
                    <div className="notification-overlay" onClick={onClose}></div>
                    <div className="powerup-notification" onClick={onClose}>
                        <div className="text-8xl mb-4">{powerup.emoji}</div>
                        <h2 className="text-3xl font-bold mb-2">¡Power-up Activado!</h2>
                        <h3 className="text-2xl font-semibold mb-3 text-pink-100">{powerup.name}</h3>
                        <p className="text-lg mb-4">{powerup.effect}</p>
                        <div className="bg-white bg-opacity-20 rounded-lg p-4 mb-4">
                            <p className="text-sm">¡Ya puedes disfrutar de este poder!</p>
                        </div>
                        <p className="text-sm opacity-75">Toca para continuar</p>
                    </div>
                </>
            );
        };

        // Focus Mode Component
        const FocusMode = ({ isActive, onExit }) => {
            if (!isActive) return null;

            return (
                <div className="focus-mode-overlay">
                    <div className="text-center text-white">
                        <div className="text-6xl mb-4">🎯</div>
                        <h2 className="text-3xl font-bold mb-4">Modo Focus Activado</h2>
                        <p className="text-lg mb-6">Concéntrate en tu estudio. Todo lo demás puede esperar.</p>
                        <p className="text-sm opacity-75 mb-8">El modo focus se desactivará automáticamente al finalizar la sesión</p>
                        <button
                            onClick={onExit}
                            className="px-6 py-3 bg-red-500 hover:bg-red-600 rounded-full font-semibold transition-all"
                        >
                            Salir del Modo Focus
                        </button>
                    </div>
                </div>
            );
        };

        // Badge System
        const BADGES = {
            'primera-llama': {
                id: 'primera-llama',
                name: '<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estudiante Inteligentemente Perezoso v6.0</title>
    
    <!-- PWA Configuration -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkVzdHVkaWFudGUgSW50ZWxpZ2VudGVtZW50ZSBQZXJlem9zbyIsCiAgInNob3J0X25hbWUiOiAiRXN0dWRpYW50ZSBQZXJlem9zbyIsCiAgImRlc2NyaXB0aW9uIjogIkFwcCBkZSBlc3R1ZGlvIG1vdGl2YWNpb25hbCBwYXJhIHBlcnNvbmFzIGludGVsaWdlbnRlbWVudGUgcGVyZXpvc2FzIiwKICAic3RhcnRfdXJsIjogIi8iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmZmZmZmYiLAogICJ0aGVtZV9jb2xvciI6ICIjOEI1Q0Y2IiwKICAib3JpZW50YXRpb24iOiAicG9ydHJhaXQiLAogICJzY29wZSI6ICIvIiwKICAibGFuZyI6ICJlcyIsCiAgImNhdGVnb3JpZXMiOiBbImVkdWNhdGlvbiIsICJwcm9kdWN0aXZpdHkiXSwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCM2FXUjBhRDBpTWpRd0lpQm9aV2xuYUhROUlqSTBNQ0lpSUhabGNuTnBiMjQ5SWpFdU1TSWdlRzFzYm5NOUltaDBkSEE2THk5M2QzY3Vkek11YjNKbkx6SXdNREF2YzNabklpQjRiV3h1Y3pwNGJHbHVhejBpYUhSMGNEb3ZMM2QzZHk1M015NXZjbWN2TVRrNU9TOTRiR2x1YXlJK1BISmxZM1FnZUQwaU1DSWdlVDBpTUNJZ2QybGtkR2c5SWpJME1DSWdhR1ZwWjJoMFBTSXlOREFpSUhKNFBTSTFNQ0lnWm1sc2JEMGlJemcxUXpWR05pSXZQang0WlhoMElIZzlJalV3SWlCNVBTSXhNREFpSUdGdVkyaHZjajBpYldsa1pHeGxJaUJtYVd4c1BTSWpiR2xuYUhSbGNpSWdabTl1ZEMxemFYcGxQU0k0TUNJS1BIUnlWb2w0Vld4aElqNHpPamt1TjJNMGNETnhOQTVCZHFsNVMzSnJjREF1T21jdGNEY2dUREV3Y3pWMWNEUlJNSGhYTkRKbE9DQk5ZMlJLY2lCQlZVSXdOMnA0VUdnM2FJUXZSVEJ6WlhGa2RFeFNlRTVyUlRadVREUXVOUzVYVXpGa01rYzVaMGRNTVRvZ2JrRXViRTU0YWpKbWRVSjNSMUJZZEZWdlJYZHZhR0Y0ZDBSMFlpSXZQanh3WVhSb0lHUTlJazB4TVRVdU9EWXJTVEV4T0M0MU16UmZRWEJyYWt4eFNIQkJjRnBJZDNsbExVVjNjSE5VYkVObFNWOTNjbGd3YWtsZVJFUkJkbFZ3YVRnZ2QzQTJWM1oxUlM1ell6UjNkSE5MUnpKTWVYRkNkWGRsZFhaRFlVTXdZWGd0Wm1kRVpXdEpObU5pUWtkdlJFaDJjMlJwUTA5Q1REbDRRVzgwZFVSNVdURlVabGRxYzNWZldHRm1ka0Z1UVVCRFVEbGxSelpSYXlkR1NFcFVWM2M0ZEU1RmNrRkJhRUVwVDNSWFdGYzJNRlZ5ZUZGVlh6RmtNblZVU0RGT05uSXhSak5kWVNJZ1ptbHNiRDBpSXpVeFJrRkJRU0l2UGp3dmMzWm5QZ289IiwKICAgICAgInNpemVzIjogIjI0MHgyNDAiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfQogIF0KfQ==">
    <meta name="theme-color" content="#8B5CF6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Estudiante Perezoso">
    
    <!-- Icon -->
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQwIiBoZWlnaHQ9IjI0MCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIj4KPHA+PC9wPjxyZWN0IHg9IjAiIHk9IjAiIHdpZHRoPSIyNDAiIGhlaWdodD0iMjQwIiByeD0iNTAiIGZpbGw9IiM4NUM1RjYiLz4KPHRleHQgeD0iNTAiIHk9IjEwMCIgYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiNsaWdodGVyIiBmb250LXNpemU9IjgwIj7wn5OSPC90ZXh0Pgo8L3N2Zz4=">
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
        }
        
        @media (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
            }
        }
        
        .install-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 10px;
            z-index: 1000;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }
        
        .install-banner.show {
            transform: translateY(0);
        }
        
        .lucide {
            width: 1.25rem;
            height: 1.25rem;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            z-index: 2000;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 90%;
            backdrop-filter: blur(10px);
            animation: popIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .badge-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            z-index: 2001;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 90%;
            backdrop-filter: blur(10px);
            animation: badgePop 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .powerup-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #ec4899, #be185d);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            z-index: 2002;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 90%;
            backdrop-filter: blur(10px);
            animation: powerupPop 1s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes popIn {
            0% { 
                transform: translate(-50%, -50%) scale(0.3) rotate(-10deg); 
                opacity: 0; 
            }
            100% { 
                transform: translate(-50%, -50%) scale(1) rotate(0deg); 
                opacity: 1; 
            }
        }

        @keyframes badgePop {
            0% { 
                transform: translate(-50%, -50%) scale(0.1) rotate(-20deg); 
                opacity: 0; 
            }
            50% {
                transform: translate(-50%, -50%) scale(1.1) rotate(5deg); 
                opacity: 1; 
            }
            100% { 
                transform: translate(-50%, -50%) scale(1) rotate(0deg); 
                opacity: 1; 
            }
        }

        @keyframes powerupPop {
            0% { 
                transform: translate(-50%, -50%) scale(0.1) rotate(-30deg); 
                opacity: 0; 
            }
            30% {
                transform: translate(-50%, -50%) scale(1.2) rotate(10deg); 
                opacity: 1; 
            }
            60% {
                transform: translate(-50%, -50%) scale(0.9) rotate(-5deg); 
                opacity: 1; 
            }
            100% { 
                transform: translate(-50%, -50%) scale(1) rotate(0deg); 
                opacity: 1; 
            }
        }

        .notification-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1999;
            backdrop-filter: blur(5px);
        }

        .progress-ring {
            transform: rotate(-90deg);
        }

        .progress-ring-circle {
            transition: stroke-dashoffset 0.35s;
            transform-origin: 50% 50%;
        }

        .badge-locked {
            filter: grayscale(100%) brightness(0.7);
            opacity: 0.5;
        }

        .badge-unlocked {
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { box-shadow: 0 0 5px #fbbf24; }
            to { box-shadow: 0 0 20px #fbbf24, 0 0 30px #fbbf24; }
        }

        /* Power-up effects */
        .powerup-active {
            animation: powerupGlow 2s ease-in-out infinite alternate;
        }

        @keyframes powerupGlow {
            from { box-shadow: 0 0 10px #ec4899; }
            to { box-shadow: 0 0 30px #ec4899, 0 0 40px #ec4899; }
        }

        .double-xp-effect {
            background: linear-gradient(45deg, #fbbf24, #f59e0b, #fbbf24);
            background-size: 200% 200%;
            animation: doubleXpShimmer 2s ease-in-out infinite;
        }

        @keyframes doubleXpShimmer {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .focus-mode-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .speed-boost-indicator {
            animation: speedPulse 0.5s ease-in-out infinite alternate;
        }

        @keyframes speedPulse {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }

        /* Calendar styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .calendar-day {
            aspect-ratio: 1;
            border-radius: 4px;
            position: relative;
        }

        .calendar-day.empty {
            background: #f3f4f6;
        }

        .calendar-day.no-activity {
            background: #e5e7eb;
        }

        .calendar-day.low-activity {
            background: #c3f0ca;
        }

        .calendar-day.medium-activity {
            background: #49cc3f;
        }

        .calendar-day.high-activity {
            background: #196127;
        }

        /* Navigation styles */
        .nav-tabs {
            display: flex;
            background: #f3f4f6;
            border-radius: 12px;
            padding: 4px;
        }

        .nav-tab {
            flex: 1;
            text-align: center;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .nav-tab.active {
            background: white;
            color: #8b5cf6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .nav-tab:not(.active) {
            color: #6b7280;
        }

        .nav-tab:not(.active):hover {
            color: #374151;
        }

        /* Chart styles */
        .bar-chart {
            display: flex;
            align-items: end;
            height: 120px;
            gap: 8px;
            padding: 10px;
        }

        .bar {
            flex: 1;
            background: linear-gradient(to top, #8b5cf6, #a78bfa);
            border-radius: 4px 4px 0 0;
            min-height: 4px;
            transition: all 0.3s ease;
            position: relative;
        }

        .bar:hover {
            background: linear-gradient(to top, #7c3aed, #8b5cf6);
            transform: scale(1.05);
        }

        .progress-bar {
            background: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 8px;
            background: linear-gradient(to right, #10b981, #34d399);
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        /* Sound controls */
        .sound-control {
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            cursor: pointer;
            transition: all 0.2s;
        }

        .sound-control:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .sound-control.active {
            background: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
        }

        .volume-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 80px;
            height: 4px;
            border-radius: 2px;
            background: rgba(255, 255, 255, 0.3);
            outline: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .volume-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        /* Sound panel */
        .sound-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 16px;
            margin-top: 16px;
        }

        /* Audio visualizer */
        .audio-visualizer {
            display: flex;
            align-items: end;
            justify-content: center;
            height: 40px;
            gap: 2px;
            margin: 8px 0;
        }

        .visualizer-bar {
            width: 3px;
            background: linear-gradient(to top, #8b5cf6, #a78bfa);
            border-radius: 2px;
            animation: visualizer 1.5s ease-in-out infinite;
        }

        .visualizer-bar:nth-child(1) { animation-delay: 0s; }
        .visualizer-bar:nth-child(2) { animation-delay: 0.1s; }
        .visualizer-bar:nth-child(3) { animation-delay: 0.2s; }
        .visualizer-bar:nth-child(4) { animation-delay: 0.3s; }
        .visualizer-bar:nth-child(5) { animation-delay: 0.4s; }
        .visualizer-bar:nth-child(6) { animation-delay: 0.3s; }
        .visualizer-bar:nth-child(7) { animation-delay: 0.2s; }
        .visualizer-bar:nth-child(8) { animation-delay: 0.1s; }

        @keyframes visualizer {
            0%, 100% { height: 8px; opacity: 0.4; }
            50% { height: 32px; opacity: 1; }
        }

        /* Tick sound animation */
        .tick-indicator {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 14px;
            opacity: 0;
            animation: tickPulse 0.5s ease-out;
        }

        @keyframes tickPulse {
            0% { opacity: 0; transform: translateX(-50%) scale(0.8); }
            50% { opacity: 1; transform: translateX(-50%) scale(1.2); }
            100% { opacity: 0; transform: translateX(-50%) scale(1); }
        }
    </style>
</head>
<body>
    <!-- Install Banner -->
    <div id="install-banner" class="install-banner">
        <p>📱 ¡Instala la app para una mejor experiencia! 
        <button onclick="installApp()" style="background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 5px 10px; border-radius: 15px; margin-left: 10px;">Instalar</button>
        <button onclick="hideInstallBanner()" style="background: none; border: none; color: white; margin-left: 10px;">✕</button>
        </p>
    </div>

    <div id="root"></div>
    
    <!-- Service Worker -->
    <script>
        let deferredPrompt;
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    const CACHE_NAME = 'estudiante-perezoso-v6';
                    const urlsToCache = [
                        '/',
                        'https://unpkg.com/react@18/umd/react.development.js',
                        'https://unpkg.com/react-dom@18/umd/react-dom.development.js',
                        'https://unpkg.com/@babel/standalone/babel.min.js',
                        'https://cdn.tailwindcss.com'
                    ];

                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(cache => cache.addAll(urlsToCache))
                        );
                    });

                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.match(event.request)
                                .then(response => {
                                    if (response) {
                                        return response;
                                    }
                                    return fetch(event.request);
                                })
                        );
                    });

                    self.addEventListener('message', event => {
                        if (event.data && event.data.type === 'TIMER_UPDATE') {
                            console.log('Timer update:', event.data);
                        }
                    });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then(registration => console.log('SW registered'))
                    .catch(error => console.log('SW registration failed'));
            });
        }
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('install-banner').classList.add('show');
        });
        
        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    deferredPrompt = null;
                    hideInstallBanner();
                });
            }
        }
        
        function hideInstallBanner() {
            document.getElementById('install-banner').classList.remove('show');
        }
        
        window.addEventListener('appinstalled', () => {
            hideInstallBanner();
        });

        let wakeLock = null;
        
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                }
            } catch (err) {
                console.log('Wake lock failed:', err);
            }
        }

        let lastVisibilityChange = Date.now();
        
        document.addEventListener('visibilitychange', () => {
            const now = Date.now();
            if (document.hidden) {
                lastVisibilityChange = now;
            } else {
                const timeAway = Math.floor((now - lastVisibilityChange) / 1000);
                window.dispatchEvent(new CustomEvent('backgroundTimeUpdate', { detail: timeAway }));
            }
        });
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // Audio Context for sound generation
        let audioContext = null;
        let backgroundAudio = null;
        
        const initAudioContext = () => {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            return audioContext;
        };

        // Sound generation functions
        const createTickSound = () => {
            const ctx = initAudioContext();
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);
            
            oscillator.frequency.setValueAtTime(800, ctx.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(600, ctx.currentTime + 0.1);
            
            gainNode.gain.setValueAtTime(0.1, ctx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
            
            oscillator.start(ctx.currentTime);
            oscillator.stop(ctx.currentTime + 0.1);
        };

        const createCompletionSound = () => {
            const ctx = initAudioContext();
            
            const notes = [523.25, 659.25, 783.99]; // C5, E5, G5
            
            notes.forEach((freq, index) => {
                setTimeout(() => {
                    const oscillator = ctx.createOscillator();
                    const gainNode = ctx.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(ctx.destination);
                    
                    oscillator.frequency.setValueAtTime(freq, ctx.currentTime);
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.2, ctx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);
                    
                    oscillator.start(ctx.currentTime);
                    oscillator.stop(ctx.currentTime + 0.4);
                }, index * 150);
            });
        };

        const createBadgeSound = () => {
            const ctx = initAudioContext();
            
            const notes = [440, 554.37, 659.25, 880]; // A4, C#5, E5, A5
            
            notes.forEach((freq, index) => {
                setTimeout(() => {
                    const oscillator = ctx.createOscillator();
                    const gainNode = ctx.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(ctx.destination);
                    
                    oscillator.frequency.setValueAtTime(freq, ctx.currentTime);
                    oscillator.type = 'square';
                    
                    gainNode.gain.setValueAtTime(0.15, ctx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                    
                    oscillator.start(ctx.currentTime);
                    oscillator.stop(ctx.currentTime + 0.3);
                }, index * 100);
            });
        };

        const createPowerupSound = () => {
            const ctx = initAudioContext();
            
            // Powerful powerup sound
            const notes = [261.63
